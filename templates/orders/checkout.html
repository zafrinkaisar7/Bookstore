{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
   <div class="container">
      <div class="row justify-content-center">
         <div class="col-lg-8 col-xl-6">
            <div class="card shadow-sm">
               <div class="card-header bg-primary text-white">
                  <h3 class="mb-0 text-center">
                     <i class="fas fa-shopping-cart me-2"></i>Checkout
                  </h3>
               </div>
               <div class="card-body p-4">
                  <form method="post">
                     {% csrf_token %}
                     <div class="row">
                        <div class="col-12 mb-4">
                           <h5 class="text-primary mb-3">
                              <i class="fas fa-user me-2"></i>Contact & Payment
                           </h5>
                           <div class="row">
                              <div class="col-md-6 mb-3">{{ form.phone|as_crispy_field }}</div>
                              <div class="col-md-6 mb-3">{{ form.payment_method|as_crispy_field }}</div>
                           </div>
                        </div>

                        <div class="col-12 mb-4">
                           <h5 class="text-primary mb-3">
                              <i class="fas fa-map-marker-alt me-2"></i>Shipping Address
                           </h5>
                           {{ form.shipping_address|as_crispy_field }}
                        </div>

                        <!-- Points Redemption Section -->
                        {% if user.customer_profile.points > 0 %}
                           <div class="col-12 mb-4">
                              <h5 class="text-primary mb-3">
                                 <i class="fas fa-star text-warning me-2"></i>
                                 Use Loyalty Points
                              </h5>
                              <div class="card border-warning">
                                 <div class="card-body p-3">
                                    <div class="row align-items-center mb-3">
                                       <div class="col-md-6">
                                          <p class="mb-1">
                                             <strong>Available Points:</strong>
                                             <span class="text-warning">{{ user.customer_profile.points }}</span>
                                          </p>
                                          <small class="text-muted">100 points = $5.00 discount</small>
                                       </div>
                                       <div class="col-md-6 text-end">
                                          <div class="form-check form-switch">{{ form.use_points|as_crispy_field }}</div>
                                       </div>
                                    </div>

                                    <div id="points-input" style="display: none;">
                                       <div class="row">
                                          <div class="col-md-8">{{ form.points_to_use|as_crispy_field }}</div>
                                          <div class="col-md-4">
                                             <div class="d-grid">
                                                <button type="button"
                                                        class="btn btn-outline-warning btn-sm"
                                                        onclick="useMaxPoints()">Use Max</button>
                                             </div>
                                          </div>
                                       </div>
                                       <div id="discount-preview" class="mt-2"></div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        {% endif %}
                     </div>

                     <!-- Order Summary -->
                     <div class="col-12 mb-4">
                        <h5 class="text-primary mb-3">
                           <i class="fas fa-receipt me-2"></i>Order Summary
                        </h5>
                        <div class="card">
                           <div class="card-body p-3">
                              <div class="table-responsive">
                                 <table class="order-table table table-sm table-bordered mb-0">
                                    <thead>
                                       <tr>
                                          <th class="text-start" style="width: 50%;">Item</th>
                                          <th class="text-center" style="width: 20%;">Quantity</th>
                                          <th class="text-end" style="width: 30%;">Price</th>
                                       </tr>
                                    </thead>
                                    <tbody>
                                       {% for item in cart.items.all %}
                                          <tr>
                                             <td class="text-start">{{ item.book.title }}</td>
                                             <td class="text-center">{{ item.quantity }}</td>
                                             <td class="text-end">${{ item.book.price }}</td>
                                          </tr>
                                       {% endfor %}
                                    </tbody>
                                    <tfoot>
                                       <tr class="subtotal-row">
                                          <td colspan="2" class="text-start">
                                             <strong>Subtotal:</strong>
                                          </td>
                                          <td class="text-end">
                                             <strong>${{ cart.total_price }}</strong>
                                          </td>
                                       </tr>
                                       <tr id="discount-row" style="display: none;">
                                          <td colspan="2" class="text-start">
                                             <strong class="text-success">Points Discount:</strong>
                                          </td>
                                          <td class="text-end">
                                             <strong class="text-success" id="discount-amount">-$0.00</strong>
                                          </td>
                                       </tr>
                                       <tr class="total-row">
                                          <td colspan="2" class="text-start">
                                             <strong>Total:</strong>
                                          </td>
                                          <td class="text-end">
                                             <strong id="final-total">${{ cart.total_price }}</strong>
                                          </td>
                                       </tr>
                                    </tfoot>
                                 </table>
                              </div>
                           </div>
                        </div>

                        <!-- Checkout Actions -->
                        <div class="col-12">
                           <div class="d-grid">
                              <button type="submit" class="btn btn-primary btn-lg">
                                 <i class="fas fa-credit-card me-2"></i>Place Order
                              </button>
                           </div>
                        </div>
                     </form>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <script>
      // Points redemption functionality
      const usePointsCheckbox = document.getElementById('id_use_points');
      const pointsInput = document.getElementById('points-input');
      const pointsToUseInput = document.getElementById('id_points_to_use');
      const discountPreview = document.getElementById('discount-preview');
      const discountRow = document.getElementById('discount-row');
      const discountAmount = document.getElementById('discount-amount');
      const finalTotal = document.getElementById('final-total');
      const availablePoints = {{ user.customer_profile.points|default:0 }};
      const cartTotal = {{ cart.total_price }};

      usePointsCheckbox.addEventListener('change', function() {
         if (this.checked) {
            pointsInput.style.display = 'block';
            updateDiscountPreview();
         } else {
            pointsInput.style.display = 'none';
            pointsToUseInput.value = 0;
            discountPreview.innerHTML = '';
            discountRow.style.display = 'none';
            finalTotal.textContent = `$${cartTotal.toFixed(2)}`;
         }
      });

      pointsToUseInput.addEventListener('input', updateDiscountPreview);

      function updateDiscountPreview() {
         const pointsToUse = parseInt(pointsToUseInput.value) || 0;
         if (pointsToUse > 0) {
            const discount = (pointsToUse / 20).toFixed(2); // 100 points = $5, so 1 point = $0.05
            const newTotal = Math.max(0, cartTotal - parseFloat(discount)).toFixed(2);
            
            // Update discount preview
            discountPreview.innerHTML = `
               <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  You will save <strong>$${discount}</strong> using ${pointsToUse} points
               </div>
            `;
            
            // Update order summary
            discountRow.style.display = 'table-row';
            discountAmount.textContent = `-$${discount}`;
            finalTotal.textContent = `$${newTotal}`;
         } else {
            discountPreview.innerHTML = '';
            discountRow.style.display = 'none';
            finalTotal.textContent = `$${cartTotal.toFixed(2)}`;
         }
      }

      function useMaxPoints() {
         pointsToUseInput.value = availablePoints;
         updateDiscountPreview();
      }

      // Form validation
      document.querySelector('form').addEventListener('submit', function(e) {
         if (usePointsCheckbox.checked) {
            const pointsToUse = parseInt(pointsToUseInput.value) || 0;
            if (pointsToUse > availablePoints) {
               e.preventDefault();
               alert('You cannot use more points than you have available.');
               return false;
            }
            if (pointsToUse <= 0) {
               e.preventDefault();
               alert('Please enter a valid number of points to use.');
               return false;
            }
         }
      });
      </script>

      <style>
      .order-table {
         width: 100%;
         table-layout: fixed;
         font-size: 0.9rem;
      }
      
      .order-table th,
      .order-table td {
         padding: 8px 6px;
         vertical-align: middle;
         word-wrap: break-word;
      }
      
      .order-table th {
         background-color: var(--card-bg);
         border-bottom: 2px solid var(--border-color);
         font-weight: 600;
         font-size: 0.85rem;
      }
      
      .order-table tbody tr:hover {
         background-color: var(--btn-hover-bg);
      }
      
      .card {
         border: 1px solid var(--border-color);
      }
      
      .card-header {
         border-bottom: 1px solid var(--border-color);
      }
      
      .form-control {
         font-size: 0.9rem;
      }
      
      .btn {
         font-size: 0.9rem;
      }
      </style>
   {% endblock content %}
